FROM envoyproxy/envoy:v1.29-latest

# –£—Å—Ç–∞–Ω–æ–≤–∏–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
RUN apt-get update && \
    apt-get install -y curl jq && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# –°–∫–∞—á–∏–≤–∞–µ–º yq –¥–ª—è —Ç–µ–∫—É—â–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
RUN ARCH=$(uname -m) && \
    case "$ARCH" in \
        aarch64) YQ_BINARY="yq_linux_arm64" ;; \
        armv7l)  YQ_BINARY="yq_linux_arm" ;; \
        x86_64) YQ_BINARY="yq_linux_amd64" ;; \
        *) echo "Unsupported architecture: $ARCH" && exit 1 ;; \
    esac && \
    curl -L "https://github.com/mikefarah/yq/releases/latest/download/${YQ_BINARY}" -o /usr/bin/yq && \
    chmod +x /usr/bin/yq

# –ö–æ–ø–∏—Ä—É–µ–º —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞
COPY run.sh /run.sh
RUN chmod +x /run.sh

# Root –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ /config
USER root

# üîΩ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ prealloc —É tcmalloc (–≤–∞–∂–Ω–æ –¥–ª—è ARM/Low-RAM)
ENV TCMALLOC_LARGE_ALLOC_REPORT_THRESHOLD=1048576
ENV TCMALLOC_HEAP_LIMIT_MB=128

CMD ["/run.sh"]


